---
alwaysApply: true
---
# üìö Reglas de Codificaci√≥n para el lenguage python

Este documento define las directrices que debe seguir cualquier asistente de IA al leer o modificar el c√≥digo de este proyecto.

## 1. Pila Tecnol√≥gica y Herramientas

- **Gestor de Paquetes y Entorno**: You will use `uv` for any operation related to dependencies or the virtual environment.
- **Calidad de C√≥digo**:
  - **Linting y Formateo**: `Ruff` es la herramienta principal. Antes de finalizar cualquier cambio de c√≥digo, ejecuta `uv run ruff format .` y `uv run ruff check . --fix`.
  - **Tipado Est√°tico**: `Mypy` es obligatorio. Todo el c√≥digo nuevo debe tener tipos estrictos. Ejecuta `uv run mypy .` para verificar los cambios.
- **Testing**: `pytest` es el framework de pruebas. Todas las nuevas funcionalidades deben seguir una metodolog√≠a TDD (Test-Driven Development).

## 2. Metodolog√≠a TDD (Test-Driven Development)

- **Ciclo de Desarrollo**: Sigue estrictamente el ciclo Rojo-Verde-Refactor.
    1. **Rojo**: Escribe una prueba que falle *antes* de escribir el c√≥digo de la funcionalidad. La prueba debe describir el comportamiento esperado.
    2. **Verde**: Escribe la cantidad m√≠nima de c√≥digo necesaria para que la prueba pase.
    3. **Refactor**: Mejora el c√≥digo (elimina duplicaci√≥n, mejora la claridad) asegur√°ndote de que todas las pruebas sigan pasando.
- **Ubicaci√≥n de las Pruebas**: Las pruebas deben residir en el directorio `/tests`, replicando la estructura del directorio `/src`. Por ejemplo, una prueba para `src/turboapi/core/di.py` deber√≠a estar en `tests/core/test_di.py`.

## 3. Estilo de C√≥digo y Convenciones

- **Formato**: Tienes que seguir estrictamente el formato impuesto por `Ruff` (`ruff format`).
- **Importaciones**: Usa importaciones absolutas siempre que sea posible. `Ruff` (`ruff check`) ordenar√° y agrupar√° las importaciones autom√°ticamente.
- **Tipado (`Typing`)**:
  - Usa anotaciones de tipo modernas (e.g., `list[str]` en lugar de `List[str]`, `str | None` en lugar de `Optional[str]`, etcetera) siempre que sea posible (Python 3.10+).
  - Todo el c√≥digo de funciones y m√©todos debe tener tipos para los argumentos y el valor de retorno.
  - Tienes que definir el tipado de los decoradores usando `ParamSpec` y `TypeVar` (para entrada y salida) siempre que est√©n soportados en la versi√≥n de `python` que se est√© usando.
- **Inyecci√≥n de Dependencias**: Prefiere siempre la inyecci√≥n por constructor. Esto hace que las dependencias sean expl√≠citas y el c√≥digo m√°s f√°cil de probar.
- Para el trabajo con rutas y ficheros

## 4. Documentaci√≥n y Comentarios

- **Docstrings**:
  - Escribe docstrings para todos los m√≥dulos, clases y funciones p√∫blicas, siguiendo el [estilo de numpy](https://www.sphinx-doc.org/en/master/usage/extensions/example_numpy.html#example-numpy).
  - Incluye una secci√≥n de ejemplos en funciones y m√©todos.
  - A√±ade los docstrings de `NamedTuple` y `dataclass` debajo de la definici√≥n de la clase.
- **Comentarios**:
  - A√±ade comentarios solo para explicar el *porqu√©* de una decisi√≥n compleja, no el *qu√©* hace el c√≥digo. El c√≥digo debe de poder explicarse por si solo.

## 5. Project Management with `uv`

These rules define strict guidelines for managing Python dependencies in this project using the `uv` dependency manager.

### 5.1 project file

The only project file you will work with is `pyproject.toml`. All tools will use this file for their configurations.

### 5.2 Use `uv` exclusively

- All Python dependencies **must be installed, synchronized, and locked** using `uv`.
- Never use `pip`, `pip-tools`, or `poetry` directly for dependency management.
- Create virtual environment, if not exists

### 5.3 Managing Dependencies

Always use these commands:

```bash
# Add or upgrade dependencies
uv add <package>

# Remove dependencies
uv remove <package>

# Reinstall all dependencies from lock file
uv sync
```

### 5.4 Scripts

```bash
# Run script with proper dependencies
uv run script.py
```

You can edit inline-metadata manually:

```python
# /// script
# requires-python = ">=3.12"
# dependencies = [
#     "torch",
#     "torchvision",
#     "opencv-python",
#     "numpy",
#     "matplotlib",
#     "Pillow",
#     "timm",
# ]
# ///

print("some python code")
```

Or using uv cli:

```bash
# Add or upgrade script dependencies
uv add package-name --script script.py

# Remove script dependencies
uv remove package-name --script script.py

# Reinstall all script dependencies from lock file
uv sync --script script.py
```

### 5.5 Running python code

- Run a Python script with `uv run <script-name>.py`
- Run Python tools like pytest, ruff or mypy with `uv run pytest` or `uv run ruff` or `uv run mypy`

## 7. Configuraci√≥n inicial del proyecto

### 7.1 Estructura de archivos recomendada

 Creo que esto ya lo hace `uv init`.

  ```text
  mi_proyecto/
  ‚îú‚îÄ‚îÄ pyproject.toml      # Dependencias y configuraci√≥n del proyecto
  ‚îú‚îÄ‚îÄ uv.lock             # Lock file generado autom√°ticamente (NO editar manualmente)
  ‚îú‚îÄ‚îÄ .python-version     # Opcional: versi√≥n de Python espec√≠fica
  ‚îú‚îÄ‚îÄ src/                # C√≥digo fuente del proyecto
  ‚îÇ   ‚îî‚îÄ‚îÄ tu_paquete/
  ‚îÇ       ‚îú‚îÄ‚îÄ **init**.py
  ‚îÇ       ‚îî‚îÄ‚îÄ ...
  ‚îî‚îÄ‚îÄ tests/              # Tests del proyecto
      ‚îî‚îÄ‚îÄ ...
  ```

### 7.2 pyproject.toml optimizado

```toml
[project]
name = "my-project"
version = "0.1.0"
description = "My project with a modern stack"
requires-python = ">=3.10"
dependencies = [
    # Your principal dependencies here
]

[project.optional-dependencies]
dev = [
    "ruff>=0.13.2",
    "mypy>=1.18.2",
    "pytest>=8.4.2",
    "pytest-asyncio>=1.2.0",
    "pytest-cov>=4.0.0",
]

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[tool.ruff]
line-length = 100
target-version = "py310"
exclude = [".venv", "build", "dist", "__pycache__"]
select = [
    "E",   # pycodestyle errors
    "W",   # pycodestyle warnings
    "F",   # pyflakes
    "I",   # isort
    "B",   # flake8-bugbear
    "C4",  # flake8-comprehensions
    "UP",  # pyupgrade
    "SIM", # rules of flake8-simplify (simplify complex code).
]
ignore = [
    "E501",  # line too long, handled by black
]

# Configuraci√≥n espec√≠fica para archivos de tests
[tool.ruff.lint.per-file-ignores]
"tests/*" = [
    "F841",   # Asigned variable but not used (common in tests)
    "B017",   # pytest.raises(Exception) (com√∫n en tests)
]

[tool.ruff.format]
quote-style = "double"
indent-style = "space"

[tool.mypy]
# Versi√≥n de Python para la que se realiza el chequeo.
python_version = "3.10"
strict = true
# No fallar si una librer√≠a de terceros no tiene typings.
ignore_missing_imports = true
# No seguir los imports de librer√≠as sin typings.
follow_imports = "silent"

# Force to all functions and method have type annotations.
disallow_untyped_defs = true
# Warn if a function return 'Any' in a implicit form.
warn_return_any = true
# Warn for unused config in this file.
warn_unused_configs = true

# Exclude dirs from type check actions.
exclude = ["\\.venv", "build", "dist", "tests"]

[tool.pytest.ini_options]
# A√±ade 'src' al PYTHONPATH para que los tests encuentren el paquete.
# pythonpaths = ["src"]
testpaths = ["tests"]
# Modo de asyncio para pytest-asyncio. 'auto' es generalmente la mejor opci√≥n.
# asyncio_mode = "auto"
addopts = [
    "--verbose",
    "--strict-markers",
    "--strict-config",
    "--cov=src",
    "--cov-report=term-missing",
    "--cov-report=html",
]
markers = [
    "slow: marks tests as slow (deselect with '-m \"not slow\"')",
    "integration: marks tests as integration tests",
]
```

### 7.2 Migraci√≥n desde requirements.txt

Si ya tienes un `requirements.txt`, la migraci√≥n es inmediata:

```bash
# Instalar uv (requiere Python 3.8+)
pip install uv

# Crear entorno virtual e instalar desde requirements.txt
uv venv
uv pip sync requirements.txt

# Opcional: generar pyproject.toml desde requirements.txt
uv init --from-requirements-txt
```

## 8. üîß Flujo de Trabajo Diario con uv

### 8.1 Comandos esenciales para el equipo

```bash
# Inicializar nuevo proyecto
uv init mi-proyecto
cd mi-proyecto

# Activar entorno virtual
source .venv/bin/activate  # Linux/Mac
# o
.venv\Scripts\activate      # Windows

# Instalar dependencias principales
uv add "fastapi" "uvicorn[standard]" "pydantic"

# Instalar dependencias de desarrollo
uv add --optional-dev "pytest" "black" "flake8"

# Instalar todas las dependencias del pyproject.toml
uv sync

# Ejecutar la aplicaci√≥n (ejemplo con Uvicorn:cite[1]:cite[2])
uvicorn src.main:app --reload --host 0.0.0.0 --port 8000
```

### 8.2 Gesti√≥n de dependencias

```bash
# A√±adir nueva dependencia
uv add "requests>=2.31.0"

# A√±adir dependencia de desarrollo
uv add --optional-dev "pytest-cov"

# Actualizar todas las dependencias
uv sync --upgrade

# Eliminar dependencia
uv remove "package-name"

# Mostrar √°rbol de dependencias
uv tree
```

## 9. üîí Configuraci√≥n para Entornos de Producci√≥n

### 9.1 Dockerfile optimizado con `uv`

```dockerfile
FROM python:3.12-slim

WORKDIR /app

# Instalar uv
RUN pip install uv

# Copiar archivos de dependencias
COPY pyproject.toml uv.lock ./

# Instalar dependencias usando cache de Docker
RUN uv sync --frozen --no-dev

# Copiar c√≥digo de la aplicaci√≥n
COPY src/ ./src/

# Exponer puerto
EXPOSE 8000

# Comando de inicio:cite[2]:cite[6]
CMD ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "4"]
```
